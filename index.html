<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroCalm — Soul Tribe Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3B82F6" />

    <!-- ✅ PAYPAL SCRIPT (PART 1) -->
    <AUbYXJjDCZPPc3h5UBZUntzdhLVDzgO6RKQlTNGSQb8n-mJ50rPufnHawT7LSirPpxNPXmkidY7y4awz>
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #0f172a;
        }

        .hidden-by-default {
            display: none;
        }

        .breathe-orb {
            width: 120px;
            height: 120px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 20%, rgba(59, 130, 246, 0.95), rgba(16, 185, 129, 0.85));
            box-shadow: 0 20px 45px rgba(14, 165, 233, 0.12),
                inset 0 -6px 18px rgba(255, 255, 255, 0.06);
            transition: transform 850ms ease-in-out, opacity 850ms ease-in-out;
        }

        @keyframes inhale-exhale {
            0% {
                transform: scale(0.9);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.08);
                opacity: 1;
            }

            100% {
                transform: scale(0.9);
                opacity: 0.9;
            }
        }

        .orb-animate {
            animation: inhale-exhale 4000ms ease-in-out infinite;
        }

        .font-lora {
            font-family: 'Lora', serif;
        }

        /* Custom style for disabled audio player */
        audio:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-slate-50">

    <!-- ✅ NAVIGATION -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="h-9 w-9 rounded-xl bg-sky-500 grid place-content-center text-white font-bold">NC</div>
                <div class="font-semibold">NeuroCalm</div>
            </div>
            <div class="flex items-center gap-3">
                <button id="navHome" class="text-gray-600 font-semibold">Home</button>
                <button id="navCourse" class="text-gray-600 font-semibold">Course</button>
                <button id="navJournal" class="text-gray-600 font-semibold">Journal</button>
                <button id="navQuick" class="text-gray-600 font-semibold">QuickPause</button>
                <button id="navSound" class="text-gray-600 font-semibold">Soundscapes</button>
                <button id="navCheckin" class="text-gray-600 font-semibold">Check-in</button>
                <button id="navCommunity" class="text-gray-600 font-semibold">Community</button>
                <button id="navPricing" class="text-gray-600 font-semibold">Pricing</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-10">
        <!-- ✅ SECTIONS -->
        <section id="landingPage" class="space-y-20">
            <div class="text-center py-20 bg-blue-50 rounded-3xl shadow-lg relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-4xl sm:text-5xl md:text-6xl font-extrabold text-blue-900 mb-4 leading-tight drop-shadow-md">
                        Find Your Inner Calm
                    </h1>
                    <p class="text-xl sm:text-2xl text-blue-800 mb-8 max-w-2xl mx-auto drop-shadow-md">
                        A simple, powerful technique for emotional freedom and lasting resilience.
                    </p>
                    <button id="startCourseBtn" class="bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-xl hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                        Start Your 21-Day Journey
                    </button>
                </div>
            </div>
        </section>

        <section id="coursePage" class="hidden-by-default max-w-4xl mx-auto space-y-6">
             <div class="bg-blue-900 text-white p-6 rounded-t-2xl shadow-lg text-center">
                <h2 id="courseModuleTitle" class="text-xl font-bold mb-2 opacity-80"></h2>
                <h3 id="courseSessionTitle" class="text-4xl font-extrabold leading-tight font-lora"></h3>
                <p id="courseProgress" class="text-sm font-semibold opacity-75 mt-2"></p>
            </div>
             <div class="bg-white p-6 rounded-b-2xl shadow-xl">
                <audio id="courseAudioPlayer" controls class="w-full" disabled></audio>
                <p id="audioStatus" class="text-center text-sm text-gray-500 mt-2 italic">Loading audio...</p>
            </div>
            <div class="bg-stone-50 p-8 rounded-2xl shadow-inner max-h-[50vh] overflow-y-auto border border-stone-200">
                <pre id="courseScript" class="text-gray-800 text-lg leading-relaxed whitespace-pre-wrap font-lora"></pre>
            </div>
            <button id="nextSessionBtn" class="w-full bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                Next Session
            </button>
        </section>

        <section id="journalPage" class="hidden-by-default">
            <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-2xl mx-auto">
                <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Cloud Journal</h1>
                <p class="text-center text-gray-500 mb-2">Reflect on your emotional journey. Your entries are saved to your account.</p>
                <p id="userIdDisplay" class="text-center text-xs text-gray-400 mb-8 truncate"></p>
                <div class="mb-8">
                    <textarea id="journalEntryInput" rows="6" placeholder="How are you feeling today? What did you learn from your session?"
                        class="w-full p-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 resize-none placeholder-gray-400 text-gray-700"></textarea>
                    <button id="saveJournalBtn"
                        class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105">
                        Save Entry to Cloud
                    </button>
                </div>
                <div class="space-y-6">
                    <h2 class="text-xl font-bold text-blue-800 mb-4">Past Entries</h2>
                    <div id="journalEntriesContainer" class="max-h-[50vh] overflow-y-auto">
                    </div>
                </div>
            </div>
        </section>

        <!-- QuickPause -->
        <section id="quickPauseSection" class="hidden-by-default card mb-8 p-6 bg-white rounded-xl shadow">
            <div class="flex gap-6 items-center">
                <div>
                    <div id="breatheOrb" class="breathe-orb orb-animate"></div>
                </div>
                <div class="flex-1">
                    <h3 class="text-2xl font-bold">QuickPause™</h3>
                    <p class="text-gray-600 mt-2">Breathing resets — Box, 4-7-8, or Calm breathing.</p>
                    <div class="mt-4 flex gap-3">
                        <button id="qpBox" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Box</button>
                        <button id="qp478" class="px-4 py-2 rounded-xl bg-slate-200">4-7-8</button>
                        <button id="qpCalm" class="px-4 py-2 rounded-xl bg-slate-200">Calm</button>
                        <button id="qpStop" class="px-4 py-2 rounded-xl bg-red-100 text-red-700">Stop</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Soundscapes -->
        <section id="soundscapesSection" class="hidden-by-default card mb-8 p-6 bg-white rounded-xl shadow">
            <h3 class="text-2xl font-bold">Soundscapes</h3>
            <p class="text-gray-600 mt-2">Alpha, Theta, Delta, Beta modes.</p>
            <div class="mt-4 flex gap-3">
                <button data-mode="alpha" class="px-4 py-2 rounded-xl bg-sky-100 text-sky-700">Alpha</button>
                <button data-mode="theta" class="px-4 py-2 rounded-xl bg-sky-100 text-sky-700">Theta</button>
                <button data-mode="delta" class="px-4 py-2 rounded-xl bg-sky-100 text-sky-700">Delta</button>
                <button data-mode="beta" class="px-4 py-2 rounded-xl bg-sky-100 text-sky-700">Beta</button>
            </div>
            <div class="mt-4 flex items-center gap-3">
                <button id="scPlay" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Play</button>
                <button id="scStop" class="px-4 py-2 rounded-xl bg-slate-200">Stop</button>
                <label class="ml-3">Volume
                    <input id="scVolume" type="range" min="0" max="1" step="0.01" value="0.35" />
                </label>
                <div class="ml-auto text-sm text-gray-500" id="scModeLabel">Mode: —</div>
            </div>
        </section>

        <!-- Check-in -->
        <section id="checkinSection" class="hidden-by-default card mb-8 p-6 bg-white rounded-xl shadow">
            <h3 class="text-2xl font-bold">Daily Check-in</h3>
            <textarea id="quickJournal" rows="4" class="w-full p-3 border rounded-xl mt-2"
                placeholder="Write a line or two..."></textarea>
            <div class="mt-3 flex gap-3">
                <button id="saveQuick" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save local</button>
            </div>
            <div id="localEntries" class="mt-3 space-y-2"></div>
        </section>

        <!-- Community -->
        <section id="communitySection" class="hidden-by-default card mb-8 p-6 bg-white rounded-xl shadow">
            <h3 class="text-2xl font-bold">Community</h3>
            <textarea id="commText" class="w-full mt-3 p-3 rounded-xl border"
                placeholder="Share encouragement..."></textarea>
            <div class="mt-3 flex gap-3">
                <button id="saveComm" class="px-4 py-2 rounded-xl bg-sky-600 text-white">Save</button>
                <button id="clearComm" class="px-4 py-2 rounded-xl bg-red-100 text-red-700">Clear</button>
            </div>
            <div id="commFeed" class="mt-4 space-y-2"></div>
        </section>

        <!-- Pricing -->
        <section id="pricingSection" class="hidden-by-default card mb-8 p-6 bg-white rounded-xl shadow">
            <h3 class="text-2xl font-bold">Pricing</h3>
            <p class="text-gray-600 mt-2">Choose your plan.</p>
            <div class="grid md:grid-cols-3 gap-6 mt-6">
                <div class="p-6 rounded-2xl border">
                    <h4 class="font-semibold">Free</h4>
                    <p class="text-2xl font-bold mt-2">$0</p>
                    <button class="mt-4 w-full px-4 py-2 bg-slate-200 rounded-xl">Start Free</button>
                </div>
                <div class="p-6 rounded-2xl border">
                    <h4 class="font-semibold">Plus</h4>
                    <p class="text-2xl font-bold mt-2">$9.99/mo</p>
                    
                    <!-- ✅ PAYPAL BUTTON CONTAINER (PART 2) -->
                    <!-- This div is where the PayPal button will be rendered. -->
                    <div id="paypal-button-container" class="mt-4"></div>

                </div>
                <div class="p-6 rounded-2xl border">
                    <h4 class="font-semibold">Pro</h4>
                    <p class="text-2xl font-bold mt-2">$14.99/mo</p>
                    <!-- Stripe placeholder -->
                    <a href="https://checkout.stripe.com/pay/REPLACE" target="_blank"
                        class="block w-full text-center mt-4 px-4 py-2 bg-slate-800 text-white border rounded-xl">Stripe Checkout</a>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Message Modal -->
     <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg text-gray-800 mb-4"></p>
            <button id="messageCloseBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-blue-700 transition-colors duration-200">
                OK
            </button>
        </div>
    </div>


    <!-- ✅ SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let app, db, auth, userId = null, journalCollectionRef = null;
        
        // --- DOM Elements ---
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const messageCloseBtn = document.getElementById('messageCloseBtn');
        const courseProgress = document.getElementById('courseProgress');
        const courseScript = document.getElementById('courseScript');
        const courseAudioPlayer = document.getElementById('courseAudioPlayer');
        const audioStatus = document.getElementById('audioStatus');
        const courseModuleTitle = document.getElementById('courseModuleTitle');
        const courseSessionTitle = document.getElementById('courseSessionTitle');
        const journalEntryInput = document.getElementById('journalEntryInput');
        const journalEntriesContainer = document.getElementById('journalEntriesContainer');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const orb = document.getElementById('breatheOrb');

        // --- App State ---
        let currentModuleIndex = 0;
        let currentSessionIndex = 0;
        let audioUrlCache = {};
        const LOCAL_STORAGE_KEY = 'neurocalm_local_v2';
        let localData = { journal: [], comm: [] };

        // --- Course Content ---
        const courseModules = [
            {
                title: 'Module 1: The Foundation of Calm',
                sessions: [
                    { title: 'Day 1: Welcome to NeuroCalm', content: `Welcome to your first step on the journey to emotional freedom. Take a moment to settle in, finding a comfortable position where you can relax. Close your eyes if you feel comfortable doing so, and simply bring your attention to your breath. Breathe in slowly through your nose... and out slowly through your mouth.\n\nToday, we're going to introduce the Havening Technique, a powerful tool for finding immediate calm. It works by creating a peaceful, soothing feeling that helps to de-link emotions from stressful memories. You can do this by gently touching your own arms, hands, or face. It's that simple.\n\nFor this first session, let's practice the "Quick Calm."\n\nBegin by gently and slowly stroking your palms. Move your hands from the wrist up to your fingertips, in a smooth, continuous motion. As you do this, notice the feeling of your palms. Feel the gentle pressure and the warmth. Breathe slowly and deeply. You might even feel a tingling sensation as you do this.\n\nNow, gently stroke the sides of your arms, from your shoulders down to your elbows. Notice the soft sensation on your skin. As you continue to breathe slowly, you are sending a signal of safety and comfort to your brain.\n\nFinally, gently massage your face, from your forehead down to your chin. Feel the soothing touch. This is a simple act of self-care that tells your nervous system it's okay to relax.\n\nThat's right. You're doing it perfectly. Continue for a moment longer.\n\nAnd now, slowly bring your hands to rest. Take one more deep, slow breath.\n\nYou can return to this simple practice whenever you feel the need for calm. It's always with you.\n\nBefore we end, please take a moment to reflect on your experience. Consider your emotional state before this session and how you feel now. You can write your thoughts in your journal.`},
                    { title: 'Day 2: The Science of Touch', content: `Welcome back. Today, we're going to look at the science behind what you experienced yesterday.\n\nThe Havening Technique is what we call a psychosensory therapy. It uses therapeutic touch to help you feel safe and calm. When you perform this gentle, slow touch, it generates something called a delta wave in your brain. This delta wave is the same type of brain wave produced during deep sleep. This soothing sensation helps to lower your anxiety levels and reset your emotional state.\n\nThis gentle, soothing touch is a powerful way to communicate with your nervous system. In this session, we'll focus on the physical sensations of touch and how they help to quiet your mind.\n\nLet's begin by returning to that gentle, calming touch. Start by slowly stroking the tops of your hands, just like you did yesterday. This time, as you do it, really pay attention to the sensation. Notice the temperature of your skin, the feeling of your fingers gliding across it.\n\nNow, move to your upper arms and shoulders. Gently and slowly, stroke from your shoulders down to your elbows. If you feel any tension, simply acknowledge it without judgment. Let the touch be a comforting blanket, inviting that tension to soften and release.\n\nNow, gently massage your face again. Feel the connection between your hands and your face. This simple act is a powerful way to ground yourself in the present moment.\n\nBreathe slowly and deeply. You are not just doing a technique; you are actively caring for yourself.\n\nAnd now, slowly bring your hands to rest. Take a deep, gentle breath, and just be in this moment of peace.\n\nTake a moment to write in your journal. Where do you typically feel stress in your body? Was there a change in that feeling during this session?`},
                    { title: 'Day 3: Releasing Daily Stress', content: `Hello again. We’ve learned how to find immediate calm and how the science of touch works. Today, let's apply that to a common feeling: the stress that builds up throughout your day.\n\nLet's begin. Find a comfortable position and place your hands on your forehead. Gently and slowly massage your forehead in circular motions, from the center outwards. Notice the feeling of your fingertips on your skin. Breathe deeply and gently.\n\nNow, bring your hands down to your temples and gently massage them. As you do this, imagine all the worries and pressures from your day melting away with each breath. Let go of the meetings, the deadlines, the to-do lists.\n\nFinally, gently stroke down the sides of your face, from your temples down to your jaw. Feel the tension in your jaw and cheeks release. Continue for a moment longer, breathing calmly.\n\nAnd now, slowly bring your hands to rest. Take a final deep, gentle breath.\n\nWhat was a source of stress today, and how did the session help you feel a sense of relief?`},
                    { title: 'Day 4: Taming Anxiety', content: `Welcome back. Today, we're going to use the power of Havening to directly address feelings of anxiety. Remember, these are just feelings, and you have the power to soothe them.\n\nBegin by bringing your hands to your upper arms. Gently and slowly stroke from your shoulders down to your elbows. As you do this, gently close your eyes and bring to mind a recent situation that made you feel anxious, but one that is minor in intensity.\n\nNotice any thoughts or physical sensations that come up. Do not judge them. Just observe them. Now, as you continue the slow, gentle touch, repeat this mantra to yourself: "I am safe. I am calm. I am okay."\n\nContinue to stroke your arms. Breathe slowly and deeply. You are actively telling your nervous system that you are safe. Feel the soothing touch. Feel the fear soften.\n\nNow, move your hands to your face and gently massage your forehead, your temples, and your cheeks. Take another slow, gentle breath, and with it, release any remaining anxious thoughts.\n\nWhat is one thought or worry you can release today?`},
                    { title: 'Day 5: The Anchor of Peace', content: `Welcome to a powerful new technique today: creating an emotional anchor. An anchor is a specific feeling or state that you can access on command. We're going to anchor the feeling of peace.\n\nBegin with a few deep, cleansing breaths. Inhale slowly... and exhale slowly.\n\nNow, bring to mind a memory of a time you felt completely at peace. Maybe it was on a tranquil beach, in a quiet forest, or even just in a peaceful moment at home. Remember the sights, the sounds, the smells, and most importantly, the feeling of that moment.\n\nNow, begin gently stroking your palms. As you do this, feel that feeling of peace. Let it wash over you. Stroke slowly and calmly. Imagine that this gentle touch is embedding that feeling of peace into your memory.\n\nNow, place your hand on your heart. Feel the warmth of your hand, the gentle rise and fall of your chest with each breath. Continue to feel that feeling of peace as you breathe.\n\nDescribe the feeling of being calm. What does it look like, sound like, feel like?`},
                    { title: 'Day 6: Setting Intentions', content: `Welcome to your morning session. Today, we'll use Havening to set a positive intention for the day ahead.\n\nFind a quiet spot and begin by gently stroking your upper arms. As you do this, think about the day ahead. What is one positive feeling you want to experience today? Perhaps it's gratitude, calm, or confidence.\n\nAs you continue to stroke your arms, imagine that feeling. See yourself moving through your day with that emotion. Feel it in your body.\n\nNow, bring your hands to your face, gently massaging your cheeks and temples. Take a moment to say your intention out loud or in your mind, such as, "Today, I choose to be calm."\n\nBreathe that intention in, and with a gentle exhale, release any doubts or fears.\n\nWhat is one positive intention you will set for today?`},
                    { title: 'Day 7: Consolidating Your Calm', content: `Congratulations on completing your first week! Today is a day to consolidate all the calm you’ve built.\n\nLet's begin with the full sequence we've learned this week. Start by gently stroking your upper arms, from your shoulders down to your elbows. Breathe slowly and deeply.\n\nNow, gently and slowly stroke your palms, feeling the calming sensation. Continue to breathe gently.\n\nFinally, gently massage your face, your forehead, and your temples. Feel the peace and calm you've cultivated.\n\nReflect on this past week. What changes have you noticed in your emotional state?`}
                ]
            },
            {
                title: 'Module 2: Reprogramming Your Mind',
                sessions: [
                    { title: 'Day 8: Identifying Triggers', content: `Welcome to Module 2. We're now moving from quick calm to lasting resilience. Today, we'll begin by identifying a specific, low-level trigger. This is a situation that causes a mild, predictable emotional response, like a feeling of annoyance or mild frustration.\n\nFind a comfortable position. Close your eyes and bring to mind a very small trigger from your past week. Maybe it was a frustrating email, a minor traffic delay, or a small social misstep. As you think about it, notice where you feel that feeling in your body.\n\nNow, begin gently stroking your arms. Continue to think of that trigger, but as you do, repeat this phrase: "It's not a threat. I am safe now."\n\nFeel the gentle, calming sensation of the touch as it helps to de-link the emotional response from the memory. Continue this until the feeling of frustration softens.\n\nWhat is a recurring emotional trigger you would like to address?`},
                    { title: 'Day 9: The Memory Reconsolidation Principle', content: `Today, we'll deepen our understanding of how Havening works on memories. When you recall a memory, it becomes "unstable" for a brief period. This is when Havening can work its magic, helping to re-file the memory without the emotional charge.\n\nThink of a non-traumatic, negative memory from the past. Perhaps a moment of embarrassment or a small mistake. Now, begin gently and slowly stroking your palms. As you do, recall the memory. Notice any thoughts, feelings, or sensations that arise.\n\nNow, while continuing the stroking, gently say out loud, "I am safe and calm now." Repeat this phrase. You are creating a new memory path, one of safety and calm, that overrides the old, charged one.\n\nContinue for as long as it feels right. When you are done, recall the memory one more time. Notice how the emotional intensity has diminished.\n\nWhat is a negative memory that you want to release the emotional charge from?`},
                    { title: 'Day 10: Releasing Self-Doubt', content: `Today, we begin a five-day series focused on specific emotional challenges. We'll start with the powerful and freeing feeling of releasing self-doubt.\n\nFind a quiet place and begin with slow, gentle strokes on your upper arms. As you do, bring to mind a recent time you felt self-doubt. Hear the voice of your inner critic. Do not argue with it. Just listen.\n\nNow, as you continue to stroke, imagine that voice is a radio station, and you are slowly turning the volume down. Repeat to yourself, "I am enough."\n\nNow, move your hands to your face and gently massage your forehead and temples. As you do, visualize a new, more supportive voice. Let it be kind and encouraging. Let it say, "You are worthy. You are capable."\n\nWhat is one limiting belief you are ready to let go of?`},
                    { title: 'Day 11: Overcoming Procrastination', content: `Procrastination is often linked to a fear of failure or a feeling of being overwhelmed. Today, we'll use Havening to soothe that feeling.\n\nThink of one task you have been putting off. Notice the feeling of resistance or overwhelm. Now, gently stroke your arms. As you do, say a simple, positive affirmation: "I can do this."\n\nNow, break the task into three simple, manageable steps. As you stroke your palms, visualize yourself completing the first step. Feel the sense of accomplishment.\n\nWhat is one small step you can take today to move forward on a task you’ve been avoiding?`},
                    { title: 'Day 12: Coping with Social Anxiety', content: `Feelings of social anxiety can be isolating. Today, we'll use Havening to help you feel more comfortable and confident in social settings.\n\nThink about a social event or conversation that makes you feel anxious. Bring that feeling to mind. Now, begin gently stroking your palms.\n\nAs you do, imagine a bubble of peace and safety around you. It protects you from judgment and fear. Within this bubble, you are free to be yourself.\n\nContinue to stroke your palms, breathing slowly, and repeat: "I am confident. I am comfortable. I am authentic."\n\nWhat is one thought you can replace your social anxiety with?`},
                    { title: 'Day 13: Letting Go of Anger', content: `Anger can be a powerful and overwhelming emotion. Today, we will use Havening to safely release it.\n\nThink of a time when you felt angry. Notice where you feel it in your body. Now, gently and slowly stroke your arms. As you do, repeat a simple phrase: "I release this anger."\n\nContinue to stroke. Breathe deeply. With each breath, imagine the anger leaving your body, being replaced with a feeling of calm.\n\nHow can you use this technique the next time you feel a flash of anger?`},
                    { title: 'Day 14: Healing from Disappointment', content: `Disappointment can feel heavy. Today, we'll use Havening to help you find a sense of peace and acceptance.\n\nBring to mind a recent disappointment. Feel the sadness or frustration. Now, gently stroke your palms. As you do, repeat: "This is a part of my story, but it does not define me."\n\nContinue to stroke, and with each exhale, let go of the emotional charge of the disappointment. Imagine a new, peaceful feeling taking its place.\n\nWhat is one lesson you can learn from a recent disappointment?`}
                ]
            },
            {
                title: 'Module 3: Building Lasting Resilience',
                sessions: [
                    { title: 'Day 15: Proactive Peace', content: `Welcome to Module 3, where we learn to build lasting resilience. Today, we’ll use Havening proactively, to prepare for a future event that might cause you stress.\n\nThink of a future event, like a presentation, a difficult conversation, or a family gathering. Notice any feelings of anxiety. Now, begin to gently stroke your arms.\n\nAs you do, visualize yourself in that situation, but this time, you are feeling calm and confident. See yourself navigating the event with ease. Feel the positive emotions.\n\nContinue to stroke your arms, and repeat: "I am prepared. I am capable. I can handle this."\n\nWhat future event are you feeling anxious about, and how did this session help?`},
                    { title: 'Day 16: Building Confidence', content: `Confidence is not something you are born with; it's something you build. Today, we'll use Havening to strengthen your belief in yourself.\n\nThink of a time you felt successful and proud of yourself. It can be a small victory or a major accomplishment. Recall that feeling. Now, begin gently stroking your palms.\n\nAs you do, repeat to yourself, "I am strong. I am successful. I am confident." Let those words sink in.\n\nNow, bring your hands to your heart. Feel the warmth and power of your own heart. Breathe in that feeling of confidence, and with each exhale, release any feelings of self-doubt.\n\nIn what areas of your life do you want to feel more confident?`},
                    { title: 'Day 17: Cultivating Joy', content: `Today, we'll use Havening to not only release negative emotions but also to amplify positive ones. We will cultivate the feeling of joy.\n\nClose your eyes and bring to mind a memory of pure joy. It could be from your childhood, a recent event, or a simple moment of happiness. As you recall it, notice the physical sensations of joy in your body.\n\nNow, gently stroke your arms. As you do, imagine that this touch is like turning up the volume on that joyful feeling. Let it expand and fill your whole being.\n\nContinue to stroke, breathing deeply, and say, "I am grateful for this feeling."\n\nRecall a recent moment of joy. How can you hold onto that feeling?`},
                    { title: 'Day 18: Improving Sleep Quality', content: `Sleep is essential for your well-being. Today, we will use a special Havening session to prepare your mind and body for restful sleep.\n\nLie down in a comfortable position. Gently stroke your arms, and as you do, imagine all the thoughts from your day slowly floating away, like clouds in the sky.\n\nNow, gently massage your face, from your forehead down to your chin. Breathe deeply. With each exhale, imagine your muscles relaxing, your eyelids growing heavy.\n\nContinue to stroke your arms and repeat: "My mind is calm. My body is at peace. I am ready to rest."\n\nWhat is one thought you can release tonight to help you sleep?`},
                    { title: 'Day 19: Finding Focus', content: `In a world full of distractions, focus can be hard to find. Today, we will use Havening to center your mind and improve your concentration.\n\nFind a quiet place and begin gently stroking your palms. As you do, think of one task you need to focus on. Gently say out loud, "I am focused."\n\nNow, bring your hands to your face and gently massage your forehead. As you do, imagine a clear, bright path leading to the completion of your task. Visualize yourself completing it with ease.\n\nWhat is one task you will use this session to focus on?`},
                    { title: 'Day 20: Managing Physical Discomfort', content: `Physical discomfort can be emotionally taxing. Today, we'll use Havening to help soothe both your mind and body.\n\nIf you have a location of minor physical discomfort, bring your hand to that area. If not, simply place your hand on your arm. Gently and slowly, stroke the area.\n\nAs you do, breathe deeply, and with each exhale, imagine the discomfort softening and releasing. Repeat to yourself: "I am soothing my body."\n\nWhat is one thing you can do to show your body kindness today?`},
                    { title: 'Day 21: Your Journey Continues', content: `Congratulations! You have completed your 21-day journey. Today is about reflecting on how far you’ve come and looking forward.\n\nBegin with the full Havening sequence one last time. Stroke your arms, your palms, and your face. As you do, remember the moments of calm you found, the memories you de-linked, and the resilience you built.\n\nNow, bring your hands to rest and take a deep, slow breath. Remember that this power is always with you.\n\nWhat is one new habit or insight you will carry forward from this course?`}
                ]
            }
        ];
        
        // --- Utility Functions ---
        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
        }
        messageCloseBtn.onclick = () => messageModal.classList.add('hidden');

        function formatDate(timestamp) {
            const date = timestamp instanceof Timestamp ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString();
        }
        
        // --- Navigation ---
        function showSection(id) {
            document.querySelectorAll('main section').forEach(sec => sec.style.display = 'none');
            const el = document.getElementById(id);
            if (el) el.style.display = 'block';
        }

        document.querySelectorAll('nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.id.replace('nav', '').toLowerCase();
                const sectionMap = {
                    home: 'landingPage',
                    course: 'coursePage',
                    journal: 'journalPage',
                    quick: 'quickPauseSection',
                    sound: 'soundscapesSection',
                    checkin: 'checkinSection',
                    community: 'communitySection',
                    pricing: 'pricingSection'
                };
                if (sectionMap[id]) {
                    showSection(sectionMap[id]);
                    // Re-render course content when navigating to the course page
                    if (id === 'course') {
                        renderCourseContent();
                    }
                }
            });
        });

        // --- Audio Generation ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            // RIFF header, fmt chunk, data chunk... (omitted for brevity, but it's the full WAV header logic)
            view.setUint8(0, 'R'.charCodeAt(0)); view.setUint8(1, 'I'.charCodeAt(0)); view.setUint8(2, 'F'.charCodeAt(0)); view.setUint8(3, 'F'.charCodeAt(0));
            view.setUint32(4, 36 + dataSize, true);
            view.setUint8(8, 'W'.charCodeAt(0)); view.setUint8(9, 'A'.charCodeAt(0)); view.setUint8(10, 'V'.charCodeAt(0)); view.setUint8(11, 'E'.charCodeAt(0));
            view.setUint8(12, 'f'.charCodeAt(0)); view.setUint8(13, 'm'.charCodeAt(0)); view.setUint8(14, 't'.charCodeAt(0)); view.setUint8(15, ' '.charCodeAt(0));
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true);
            view.setUint8(36, 'd'.charCodeAt(0)); view.setUint8(37, 'a'.charCodeAt(0)); view.setUint8(38, 't'.charCodeAt(0)); view.setUint8(39, 'a'.charCodeAt(0));
            view.setUint32(40, dataSize, true);
            new Int16Array(buffer, 44).set(pcmData);
            return new Blob([view], { type: 'audio/wav' });
        }
        
        async function generateAudio(text) {
             const apiKey = "";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
             const cleanedText = text.replace(/\[.*?\]/g, '').replace(/\*\*/g, '');
             const speechPrompt = `Say in a calm, soothing, gentle, and slow voice: ${cleanedText}`;
             const payload = { contents: [{ parts: [{ text: speechPrompt }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }, model: "gemini-2.5-flash-preview-tts" };
             try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType?.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcm16 = new Int16Array(base64ToArrayBuffer(audioData));
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    return URL.createObjectURL(wavBlob);
                } else { throw new Error('Audio data not found in response.'); }
             } catch (error) {
                 console.error("Error generating audio:", error);
                 showMessage(`Audio could not be generated. Please try again later.`);
                 return null;
             }
        }

        // --- Course Logic ---
        async function renderCourseContent() {
            const session = courseModules[currentModuleIndex].sessions[currentSessionIndex];
            const sessionId = `${currentModuleIndex}-${currentSessionIndex}`;
            courseModuleTitle.textContent = courseModules[currentModule-index].title;
            courseSessionTitle.textContent = session.title;
            courseScript.textContent = session.content.replace(/\[.*?\]/g, '').replace(/\*\*/g, '');
            courseAudioPlayer.src = "";
            courseAudioPlayer.setAttribute('disabled', 'true');
            audioStatus.textContent = 'Generating audio, please wait...';
            
            let audioUrl = audioUrlCache[sessionId] || await generateAudio(session.content);
            if (audioUrl) {
                audioUrlCache[sessionId] = audioUrl;
                courseAudioPlayer.src = audioUrl;
                courseAudioPlayer.removeAttribute('disabled');
                audioStatus.textContent = 'Audio ready. Press play to listen.';
            } else { audioStatus.textContent = 'Audio could not be loaded.'; }

            const totalSessions = courseModules.reduce((acc, m) => acc + m.sessions.length, 0);
            const sessionsCompleted = courseModules.slice(0, currentModuleIndex).reduce((acc, m) => acc + m.sessions.length, 0) + currentSessionIndex + 1;
            courseProgress.textContent = `Progress: Session ${sessionsCompleted} of ${totalSessions}`;
            document.getElementById('nextSessionBtn').textContent = (sessionsCompleted === totalSessions) ? "Complete Course" : "Next Session";
        }

        function nextSession() {
            const oldSessionId = `${currentModuleIndex}-${currentSessionIndex}`;
            if (audioUrlCache[oldSessionId]) { URL.revokeObjectURL(audioUrlCache[oldSessionId]); delete audioUrlCache[oldSessionId]; }
            if (currentSessionIndex < courseModules[currentModuleIndex].sessions.length - 1) { currentSessionIndex++; }
            else if (currentModuleIndex < courseModules.length - 1) { currentModuleIndex++; currentSessionIndex = 0; }
            else { showMessage("Congratulations! You have completed the entire course."); return; }
            renderCourseContent();
        }

        // --- Firebase (Cloud) Journal ---
        function renderFirebaseJournal(entries) {
            journalEntriesContainer.innerHTML = '';
            if (entries.length === 0) { journalEntriesContainer.innerHTML = '<p class="text-gray-400 text-center py-8">Your cloud journal is empty.</p>'; return; }
            entries.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());
            entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'bg-white p-6 rounded-2xl shadow-md mb-4';
                entryDiv.innerHTML = `<div class="flex justify-between items-start mb-2"><h3 class="text-lg font-semibold text-blue-600">${formatDate(entry.timestamp)}</h3></div><p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${entry.content}</p>`;
                journalEntriesContainer.appendChild(entryDiv);
            });
        }
        
        async function saveFirebaseJournal() {
            const entryText = journalEntryInput.value.trim();
            if (entryText === "" || !journalCollectionRef) return;
            this.disabled = true; this.textContent = 'Saving...';
            try {
                await addDoc(journalCollectionRef, { content: entryText, timestamp: new Date() });
                journalEntryInput.value = '';
                showMessage('Journal entry saved to the cloud!');
            } catch (e) { console.error("Error adding document: ", e); showMessage("Failed to save entry."); }
            finally { this.disabled = false; this.textContent = 'Save Entry to Cloud'; }
        }

        // --- Local Storage Features ---
        function loadLocalData() {
            try { localData = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || localData; } catch { }
        }
        function saveLocalData() { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localData)); }

        // Local Check-in
        function renderLocalJournal() {
            const c = document.getElementById('localEntries');
            c.innerHTML = '';
            for (let e of localData.journal.slice(-10).reverse()) {
                const div = document.createElement('div');
                div.className = 'p-2 rounded bg-slate-100 text-sm';
                div.textContent = new Date(e.ts).toLocaleString() + " — " + e.text;
                c.appendChild(div);
            }
        }
        document.getElementById('saveQuick').onclick = () => {
            const txt = document.getElementById('quickJournal').value.trim();
            if (!txt) return;
            localData.journal.push({ ts: Date.now(), text: txt.replace(/</g, "&lt;") });
            saveLocalData(); renderLocalJournal(); document.getElementById('quickJournal').value = '';
        };

        // Local Community Feed
        function renderComm() {
            const c = document.getElementById('commFeed'); c.innerHTML = '';
            for (let e of localData.comm.slice(-10).reverse()) {
                const div = document.createElement('div');
                div.className = 'p-2 rounded bg-slate-100 text-sm';
                div.textContent = new Date(e.ts).toLocaleString() + " — " + e.text;
                c.appendChild(div);
            }
        }
        document.getElementById('saveComm').onclick = () => {
            const txt = document.getElementById('commText').value.trim();
            if (!txt) return;
            localData.comm.push({ ts: Date.now(), text: txt.replace(/</g, "&lt;") });
            saveLocalData(); renderComm(); document.getElementById('commText').value = '';
        };
        document.getElementById('clearComm').onclick = () => { localData.comm = []; saveLocalData(); renderComm(); };

        // --- Soundscapes (binaural) ---
        class Binaural {
            constructor() { this.ctx = null; this.gain = null; this.left = null; this.right = null; this.mode = 'alpha'; }
            ensure() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (!this.gain) { this.gain = this.ctx.createGain(); this.gain.gain.value = 0.35; this.gain.connect(this.ctx.destination); } }
            params(mode) { return { alpha: { base: 200, beat: 10 }, theta: { base: 160, beat: 5 }, delta: { base: 110, beat: 2 }, beta: { base: 250, beat: 18 } }[mode]; }
            start() {
                this.ensure(); this.stop(); const p = this.params(this.mode);
                this.left = this.ctx.createOscillator(); this.right = this.ctx.createOscillator();
                this.left.type = this.right.type = 'sine';
                this.left.frequency.value = p.base - p.beat / 2; this.right.frequency.value = p.base + p.beat / 2;
                const panL = this.ctx.createStereoPanner(); panL.pan.value = -1; const panR = this.ctx.createStereoPanner(); panR.pan.value = 1;
                this.left.connect(panL).connect(this.gain); this.right.connect(panR).connect(this.gain);
                this.left.start(); this.right.start();
            }
            stop() { this.left?.stop(); this.right?.stop(); this.left = this.right = null; }
        }
        const soundEngine = new Binaural();
        
        // --- Event Listeners ---
        document.getElementById('startCourseBtn').addEventListener('click', () => { showSection('coursePage'); renderCourseContent(); });
        document.getElementById('nextSessionBtn').addEventListener('click', nextSession);
        document.getElementById('saveJournalBtn').addEventListener('click', saveFirebaseJournal);
        document.getElementById('qpBox').onclick = () => { orb.classList.add('orb-animate'); orb.style.animationDuration = "4000ms"; };
        document.getElementById('qp478').onclick = () => { orb.classList.add('orb-animate'); orb.style.animationDuration = "7000ms"; };
        document.getElementById('qpCalm').onclick = () => { orb.classList.add('orb-animate'); orb.style.animationDuration = "5200ms"; };
        document.getElementById('qpStop').onclick = () => orb.classList.remove('orb-animate');
        document.querySelectorAll('#soundscapesSection [data-mode]').forEach(btn => {
            btn.onclick = () => { soundEngine.mode = btn.dataset.mode; document.getElementById('scModeLabel').textContent = "Mode: " + btn.dataset.mode; };
        });
        document.getElementById('scPlay').onclick = () => soundEngine.start();
        document.getElementById('scStop').onclick = () => soundEngine.stop();
        document.getElementById('scVolume').oninput = e => { if (soundEngine.gain) soundEngine.gain.gain.value = Number(e.target.value); };

        // --- App Initialization ---
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                } else { document.getElementById('navJournal').style.display = 'none'; return; }
            } catch (e) { console.error('Firebase init failed:', e); return; }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    journalCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/journals`);
                    onSnapshot(journalCollectionRef, (snap) => {
                        const entries = snap.docs.map(doc => doc.data());
                        renderFirebaseJournal(entries);
                    }, (err) => console.error("Journal snapshot error: ", err));
                } else {
                    try {
                        if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                        else await signInAnonymously(auth);
                    } catch (error) { console.error("Auth error:", error); }
                }
            });
        }
        
        window.onload = () => {
            showSection('landingPage');
            initFirebase();
            loadLocalData();
            renderLocalJournal();
            renderComm();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            }
        };

    </script>
    
    <!-- ✅ PAYPAL BUTTON RENDERING SCRIPT -->
    <script>
        paypal.Buttons({
            // Sets up the transaction when a payment button is clicked
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        description: 'NeuroCalm Plus Subscription',
                        amount: {
                            value: '9.99' // The amount for the transaction
                        }
                    }]
                });
            },
            // Finalize the transaction after buyer approval
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(orderData) {
                    // Successful capture! 
                    console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                    // You can show a success message to the buyer
                    alert('Transaction completed by ' + orderData.payer.name.given_name);
                });
            },
            onError: function (err) {
                // Log the error for debugging
                console.error('An error occurred with the PayPal button:', err);
                 // You can show an error message to the buyer
                alert('An error occurred with your payment. Please try again.');
            }
        }).render('#paypal-button-container');
    </script>
</body>

</html>




